<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" ></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" ></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" ></script>
    <script src="http://tabulator.info/js/tabulator/3.5/tabulator.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.js"></script>
    <script src="https://syntagmatic.github.io/parallel-coordinates/examples/lib/d3.min.js"></script>
    <script src="https://syntagmatic.github.io/parallel-coordinates/d3.parcoords.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.5.2/css/tabulator.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://syntagmatic.github.io/parallel-coordinates/d3.parcoords.css">
    <link rel="stylesheet" type="text/css" href="https://syntagmatic.github.io/parallel-coordinates/examples/style.css">


<style>
.plotly-notifier{
  visibility: hidden;
}
.tabulator-cell{height:100px; background-color: white}

#div0{
    width: 100%;height: 100%;
    }
#div1{
	width: 50%;height: 100%;float: left;
	}
#div2{
	width: 50%;height: 100%;float: right;
	}
</style>
</head>
<body>
<div id="div0">
    <div id="div1">
        <div id="linechart" method="post"></div>
        <h4 id="result"> click me</h4>
        <div id="correlation_table" style="height:100%; width:100%;"></div>
    </div>

    <div id="div2">
         <div id="origin_data" class="parcoords" style="height:200px;"></div>
        <div id="eigenvector" class="parcoords" style="height:200px;"></div>
    </div>
</div>

<script type="text/javascript">
      function do_ajax2() {
        var req = new XMLHttpRequest();
        var result = document.getElementById('result');
        req.onreadystatechange = function()
        {
          if(this.readyState == 4 && this.status == 200) {
            result.innerHTML = "OK";
            new_correlation_matrix = JSON.parse(this.responseText)["new_correlation_matrix"]; //update correlation table
            new_time_series = JSON.parse(this.responseText)["time_start_end"];
            new_correlation_header = JSON.parse(this.responseText)["new_header"];
            table_parent = document.getElementById("correlation_table").parentNode;
            table_parent.removeChild(document.getElementById("correlation_table"));
            oDiv=document.createElement('div');
            oDiv.setAttribute("id", "correlation_table");
            table_parent.appendChild(oDiv);
            create_correlation_table(new_correlation_matrix, new_correlation_header);



          } else {
            result.innerHTML = "処理中...";
          }
        }
        req.open('POST', '/linechart', true);
        req.setRequestHeader('content-type', 'application/x-www-form-urlencoded;charset=UTF-8');
        req.send("time=" + selected_time_start + "," + selected_time_end);
      }
    </script>



<script>
//line chart
var application_name = {{application_name|tojson}};
timeseries = {{timeseries|tojson}}["timeseries"];
var line_chart_data = [{
                mode: 'lines',
                x: {{timeseries|tojson}}["timeseries"],
                y: {{latency_90|tojson}}["latency_90"]
                     }];
var line_chart_layout = {
                title: application_name + ' Preformance & Pressure',
                xaxis: {

                    //rangeselector: selectorOptions,
                    rangeslider: {}
                },
                yaxis: {
                    fixedrange: true
                }
                        };
selected_time_start = "";
selected_time_end = "";
Plotly.plot('linechart', line_chart_data, line_chart_layout, {displayModeBar: false})
.then(gd => {
  var isMouseDown = false;
  gd.addEventListener('mousedown', () => {
    console.log('mousedown!')
    isMouseDown = true
  })

  document.addEventListener('mouseup', () => {
    if (isMouseDown) {
      console.log('mouseup!')
      selected_time_range = document.getElementById("linechart").layout.xaxis.range;
      selected_time_start = timeseries[Math.round(selected_time_range[0])];
      selected_time_end = timeseries[Math.round(selected_time_range[1])];
      console.log(selected_time_start);
      console.log(selected_time_end);
      do_ajax2();
      isMouseDown = false
    }
  })
});
</script>

<script type="text/javascript">
function create_correlation_table(correlation_matrix, correlation_header){
    correlation_table_columns = [];
    correlation_table_width = document.getElementById("correlation_table").offsetWidth;
    correlation_cell_width = correlation_table_width/ correlation_header.length;
    console.log(correlation_matrix);
    cellFormatter = function(cell, formatterParams){
        a = cell.getElement();
        c_v = cell.getValue();
        cell.getElement().css({"height":"100%"});
        if (typeof(c_v) == "string"){
              c_v = parseFloat(c_v);
              if (c_v < -0.7 && c_v > -1){
              cell.getElement().css({"background":"#C1CDC1"});
              }
              if (c_v >= -0.7 && c_v <= -0.4){
              cell.getElement().css({"background":"#CDC1C5"});
              }
              if (c_v > -0.4 && c_v <= -0.15){
              cell.getElement().css({"background":"#EEE0E5"});
              }
              if (c_v > -0.15 && c_v < 0){
              cell.getElement().css({"background":"#E6E6FA"});
              }

              if (c_v > 0.7 && c_v < 1){
              cell.getElement().css({"background":"#FFC1C1"});
              }
              if (c_v <= 0.7 && c_v >= 0.4){
              cell.getElement().css({"background":"#FFDAB9"});
              }
              if (c_v < 0.4 && c_v >= 0.15){
              cell.getElement().css({"background":"#FFEBCD"});
              }
              if (c_v < 0.15 && c_v > 0){
              cell.getElement().css({"background":"#FFFAF0"});
              }

              return c_v;
        }
        else{
               var trace2 = {
                  x: c_v[0],
                  y: c_v[1],
                  mode: 'markers',
                  type: 'scatter',
                  marker: {
                    size: 1
                  }
                     };
               var layout2 = { autosize: false, width: correlation_cell_width, height: correlation_cell_width, margin: { l: 10, r: 10, b: 10, t: 10, pad: 10 }};
               Plotly.plot( a[0], [trace2], layout2 ,{displayModeBar: false});
        }



    };
     for (var i=0; i<correlation_header.length; i++){ //{ "title":"rS", "field":"rS", width:80, align:"center"},
        var t_c = {"title": correlation_header[i], "field": correlation_header[i], "width": correlation_cell_width, align:"center"};

        if (i >= 1){
            t_c["formatter"] = cellFormatter;
        }
        correlation_table_columns.push(t_c);

    }
	$("#correlation_table").tabulator({
	    data:correlation_matrix,
	    layout:"fitColumns",
	    columns: correlation_table_columns

    });
    $("#correlation_table").tabulator("setData", correlation_matrix);



}
</script>

<script type="text/javascript">
//correlation table

$("#correlation_table").ready(function() {
    correlation_matrix = {{correlation_matrix|tojson}}["correlation_matrix"];
    correlation_header = {{correlation_header|tojson}}["correlation_header"];
    create_correlation_table(correlation_matrix, correlation_header);
});


</script>


<script id="brushing">
jQuery.support.cors = true;
$("document").ready(function() {
application_name = "pmd";
parallel_url = {{parallel_url|tojson}};
header_raw = ["BW", "MEM_BW", "switch", "cpu", "io", "memory", "network"];
header_eigen = ["66.97%","15.16%","14.04%","3.55%","0.19%"];
var parcoords = d3.parcoords()("#origin_data")
  .alpha(0.4);

var eigenvector = d3.parcoords()("#eigenvector")
  .alpha(0.4);

d3.csv(parallel_url, function(data) {
    parcoords
        .data(data)
        .hideAxis(header_eigen)
        .render()
        .interactive()
        .brushMode("1D-axes");  // enable brushing

    eigenvector
        .data(data)
        .hideAxis(header_raw)
        .render()
        .interactive()
        .brushMode("1D-axes");  // enable brushing

    parcoords.on("brush", function(d) {
	  eigenvector.highlight(d);
          }	);

    eigenvector.on("brush", function(d) {
		parcoords.highlight(d);
          }	);


});


});
</script>



</body>
</html>